import React, { useCallback, useEffect, useState, useRef } from 'react';
import { useParams } from 'react-router-dom';
import LeftSideBar from './LeftSideBar';
import RightSideBar from './RightSideBar';
import WorkspaceCanvas, { type WorkspaceMode } from './WorkspaceCanvas';
import { WorkspaceProvider, useWorkspace } from './WorkSpace';
import type { WorkspaceTable, WorkspaceTableColor, WorkspaceRelation, RelationType } from './WorkSpace';
import ImportModal from './components/ImportModal';
import ExportModal from './components/ExportModal';
import ImportResultModal from './components/ImportResultModal';
import ImportRetryModal from './components/ImportRetryModal';
import type { ExportDatabase } from './components/ExportModal';
import BuildSuccessIcon from '../../assets/icons/build_success_icon.svg?react';
import { ErdWebSocketClient } from '../../services/websocket';
import { useAuthStore } from '../../stores/authStore';
import { useAiDraftStore } from '../../stores/aiDraftStore';
import RemoteCursor from './components/RemoteCursor';
import type { RemoteCursor as RemoteCursorType } from '../../services/websocket/types';
import useViewerStream from '../../hooks/useSSEViewer';
import AiDraftConfirmBanner from './components/AiDraftConfirmModal';
import { exportErdToSql, type SqlDialect } from '../../apis/exportApi';

const dummySqlPreview: Record<ExportDatabase, string> = {
  mysql: `-- MySQL Export ì˜ˆì‹œ
CREATE TABLE customers (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO customers (name, email)
VALUES
  ('í™ê¸¸ë™', 'hong.gildong@example.com'),
  ('ê¹€ì˜í¬', 'kim.younghee@example.com');`,
  postgresql: `-- PostgreSQL Export ì˜ˆì‹œ
CREATE TABLE customers (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO customers (name, email)
VALUES
  ('í™ê¸¸ë™', 'hong.gildong@example.com'),
  ('ê¹€ì˜í¬', 'kim.younghee@example.com');`,
};

const IMPORT_ERROR_SQL = `CREATE TABLE "snapshots" (
  "snapshot_key" BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  "project_key" INTEGER NOT NULL,
  "created_by" INTEGER NOT NULL,
  "name" VARCHAR(500) NOT NULL DEFAULT '',
  "schema" JSONB NOT NULL DEFAULT '{}',
  "created_at" TIMESTAMPTZ NOT NULL DEFAULT now()
);`;

const IMPORT_ERROR_CHANGE_SUMMARY = [
  'snapshots.snapshot_key ì»¬ëŸ¼ì„ BIGINT IDENTITYë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.',
  'schema ì»¬ëŸ¼ì„ JSONB íƒ€ì…ìœ¼ë¡œ ì§€ì •í•˜ì—¬ JSON êµ¬ì¡° ì €ì¥ì„ ì§€ì›í•©ë‹ˆë‹¤.',
  'created_at ì»¬ëŸ¼ì— ê¸°ë³¸ê°’ now()ë¥¼ ì¶”ê°€í•˜ì—¬ ìƒì„± ì‹œê°„ì„ ìë™ ì €ì¥í•©ë‹ˆë‹¤.',
];

const IMPORT_CORRECTED_TABLES: WorkspaceTable[] = [
  {
    id: 'table-projects',
    name: 'projects',
    identifier: 'projects',
    x: 180,
    y: 140,
    color: 'blue',
    columns: [
      {
        id: 'column-projects-project-key',
        isPK: true,
        isFK: false,
        logicalName: 'í”„ë¡œì íŠ¸ í‚¤',
        physicalName: 'project_key',
        dataType: 'INTEGER',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í”„ë¡œì íŠ¸ ì‹ë³„ì',
      },
      {
        id: 'column-projects-name',
        isPK: false,
        isFK: false,
        logicalName: 'í”„ë¡œì íŠ¸ëª…',
        physicalName: 'name',
        dataType: 'VARCHAR(255)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í”„ë¡œì íŠ¸ ì´ë¦„',
      },
      {
        id: 'column-projects-owner',
        isPK: false,
        isFK: false,
        logicalName: 'ìƒì„±ì',
        physicalName: 'created_by',
        dataType: 'INTEGER',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í”„ë¡œì íŠ¸ ìƒì„±ì',
      },
    ],
  },
  {
    id: 'table-snapshots',
    name: 'snapshots',
    identifier: 'snapshots',
    x: 420,
    y: 120,
    color: 'user2',
    columns: [
      {
        id: 'column-snapshots-key',
        isPK: true,
        isFK: false,
        logicalName: 'ìŠ¤ëƒ…ìƒ· í‚¤',
        physicalName: 'snapshot_key',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: 'IDENTITY',
        comment: 'ìŠ¤ëƒ…ìƒ· ì‹ë³„ì',
      },
      {
        id: 'column-snapshots-project-key',
        isPK: false,
        isFK: false,
        logicalName: 'í”„ë¡œì íŠ¸ í‚¤',
        physicalName: 'project_key',
        dataType: 'INTEGER',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ì—°ê²°ëœ í”„ë¡œì íŠ¸',
      },
      {
        id: 'column-snapshots-schema',
        isPK: false,
        isFK: false,
        logicalName: 'ìŠ¤í‚¤ë§ˆ',
        physicalName: 'schema',
        dataType: 'JSONB',
        allowNull: 'NOT NULL',
        defaultValue: '{}',
        comment: 'ERD JSON ë°ì´í„°',
      },
      {
        id: 'column-snapshots-created-at',
        isPK: false,
        isFK: false,
        logicalName: 'ìƒì„± ì¼ì‹œ',
        physicalName: 'created_at',
        dataType: 'TIMESTAMPTZ',
        allowNull: 'NOT NULL',
        defaultValue: 'now()',
        comment: 'ìƒì„± ì‹œê°',
      },
    ],
  },
  {
    id: 'table-entities',
    name: 'entities',
    identifier: 'entities',
    x: 260,
    y: 340,
    color: 'user3',
    columns: [
      {
        id: 'column-entities-key',
        isPK: true,
        isFK: false,
        logicalName: 'ì—”í‹°í‹° í‚¤',
        physicalName: 'entity_key',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: 'IDENTITY',
        comment: 'ì—”í‹°í‹° ì‹ë³„ì',
      },
      {
        id: 'column-entities-snapshot-key',
        isPK: false,
        isFK: false,
        logicalName: 'ìŠ¤ëƒ…ìƒ· í‚¤',
        physicalName: 'snapshot_key',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ì—°ê²°ëœ ìŠ¤ëƒ…ìƒ·',
      },
      {
        id: 'column-entities-name',
        isPK: false,
        isFK: false,
        logicalName: 'ì—”í‹°í‹°ëª…',
        physicalName: 'name',
        dataType: 'VARCHAR(255)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ERD ì—”í‹°í‹° ì´ë¦„',
      },
    ],
  },
  {
    id: 'table-entity-columns',
    name: 'entity_columns',
    identifier: 'entity_columns',
    x: 520,
    y: 320,
    color: 'user4',
    columns: [
      {
        id: 'column-entity-columns-key',
        isPK: true,
        isFK: false,
        logicalName: 'ì»¬ëŸ¼ í‚¤',
        physicalName: 'entity_column_key',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: 'IDENTITY',
        comment: 'ì—”í‹°í‹° ì»¬ëŸ¼ ì‹ë³„ì',
      },
      {
        id: 'column-entity-columns-entity-key',
        isPK: false,
        isFK: false,
        logicalName: 'ì—”í‹°í‹° í‚¤',
        physicalName: 'entity_key',
        dataType: 'BIGINT',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ì—°ê²°ëœ ì—”í‹°í‹°',
      },
      {
        id: 'column-entity-columns-name',
        isPK: false,
        isFK: false,
        logicalName: 'ì»¬ëŸ¼ëª…',
        physicalName: 'column_name',
        dataType: 'VARCHAR(255)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'í•„ë“œ ëª…ì¹­',
      },
      {
        id: 'column-entity-columns-type',
        isPK: false,
        isFK: false,
        logicalName: 'ë°ì´í„° íƒ€ì…',
        physicalName: 'data_type',
        dataType: 'VARCHAR(100)',
        allowNull: 'NOT NULL',
        defaultValue: '',
        comment: 'ë°ì´í„° íƒ€ì…',
      },
    ],
  },
];

type ImportResultState = {
  type: 'error';
  correctedSql: string;
  changeSummary: string[];
  tables: WorkspaceTable[];
};

const cloneTables = (tables: WorkspaceTable[]): WorkspaceTable[] =>
  tables.map((table) => ({
    ...table,
    columns: table.columns.map((column) => ({ ...column })),
  }));

interface WorkspaceLayoutProps {
  mode?: WorkspaceMode;
}

const WorkspaceLayout: React.FC<WorkspaceLayoutProps> = ({ mode = 'edit' }) => {
  const {
    projectKey,
    activeTool,
    setActiveTool,
    replaceTables,
    updateTablePosition,
    addTableFromWebSocket,
    updateTableFromWebSocket,
    removeTableFromWebSocket,
    addColumnFromWebSocket,
    updateColumnFromWebSocket,
    updateColumnByKeyFromWebSocket,
    removeColumnFromWebSocket,
    addRelationFromWebSocket,
    removeRelationFromWebSocket,
    setTableLockState,
    // handleAiDraftConfirm,
    handleAiDraftCancel,
  } = useWorkspace();
  const isViewMode = mode === 'view';
  const [sqlPreview, setSqlPreview] = useState('');
  const [isPreviewLoading, setIsPreviewLoading] = useState(false);
  const [isCopying, setIsCopying] = useState(false);
  const [showCopyToast, setShowCopyToast] = useState(false);
  const [isImportProcessing, setIsImportProcessing] = useState(false);
  const [importResult, setImportResult] = useState<ImportResultState | null>(
    null,
  );
  const [isImportResultOpen, setIsImportResultOpen] = useState(false);
  const [isImportRetryOpen, setIsImportRetryOpen] = useState(false);

  // URLì—ì„œ projectKey ê°€ì ¸ì˜¤ê¸°
  const params = useParams<{ projectKey: string; viewId: string }>();

  const setProjectKey = useAuthStore((state) => state.setProjectKey);

  // AI Draft Store
  const aiDraftResult = useAiDraftStore((state) => state.aiDraftResult);
  const aiPreviewTables = useAiDraftStore((state) => state.previewTables);

  // AI Draft ëª¨ë‹¬ ìƒíƒœ (aiDraftResultê°€ ìˆìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ)
  const isAiDraftConfirmOpen = !!aiDraftResult;

  // WebSocket ê´€ë ¨ ìƒíƒœ
  const wsClientRef = useRef<ErdWebSocketClient | null>(null);
  const currentUser = useAuthStore((state) => state.currentUser);

  // ì›ê²© ì»¤ì„œ ìƒíƒœ (ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ì»¤ì„œ)
  const [remoteCursors, setRemoteCursors] = useState<
    Record<string, RemoteCursorType>
  >({});

  const viewerLinkKey = params.viewId;

  useViewerStream(isViewMode, viewerLinkKey);

  // projectKeyë¥¼ authStoreì— ì €ì¥
  useEffect(() => {
    if (params.projectKey) {
      const projectKeyNum = parseInt(params.projectKey, 10);
      if (!isNaN(projectKeyNum)) {
        setProjectKey(projectKeyNum);
      }
    }
  }, [params.projectKey, setProjectKey]);

  // WebSocket ì´ˆê¸°í™”
  useEffect(() => {
    if (isViewMode) return; // ë·°ì–´ ëª¨ë“œì—ì„œëŠ” WebSocket ì‚¬ìš© ì•ˆ í•¨

    // authStoreì—ì„œ ì‹¤ì œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const projectKey = useAuthStore.getState().projectKey;

    // projectKeyê°€ ì—†ìœ¼ë©´ ì—°ê²°í•˜ì§€ ì•ŠìŒ
    if (!projectKey) {
      console.warn('âš ï¸ No projectKey found, skipping WebSocket connection');
      return;
    }

    console.log('ğŸ”Œ Initializing WebSocket...');
    console.log('Project Key:', projectKey);
    console.log('User:', currentUser);

    // accessTokenì€ ì„ì‹œë¡œ ë¹ˆ ë¬¸ìì—´ (ì¿ í‚¤ë¡œ ì¸ì¦ ì²˜ë¦¬)
    const wsClient = new ErdWebSocketClient({
      projectKey,
      accessToken: '',
    });

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    wsClient.setEventHandlers({
      onTableMove: (event) => {
        console.log('ğŸ“¥ Received TABLE_MOVE:', event);
        const tableEvent = event.event as {
          tableKey: number;
          xPosition: number;
          yPosition: number;
        };

        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ (ì´ë¯¸ ë¡œì»¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ)
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í…Œì´ë¸” ì´ë™ â†’ í™”ë©´ ì—…ë°ì´íŠ¸
        updateTablePosition(`table-${tableEvent.tableKey}`, {
          x: tableEvent.xPosition,
          y: tableEvent.yPosition,
        });
      },
      onCursorMove: (event) => {
        console.log('ğŸ“¥ Received CURSOR_MOVE:', event);
        const cursorEvent = event.event as {
          userEmail?: string;
          userName?: string;
          userColor?: string;
          xPosition: number;
          yPosition: number;
        };

        // ìê¸° ì»¤ì„œëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì»¤ì„œ ì—…ë°ì´íŠ¸
        const userEmail = cursorEvent.userEmail || `user-${event.userKey}`;
        setRemoteCursors((prev) => ({
          ...prev,
          [userEmail]: {
            userEmail,
            userName: cursorEvent.userName || 'ìµëª…',
            userColor: cursorEvent.userColor || '#3b82f6',
            xPosition: cursorEvent.xPosition,
            yPosition: cursorEvent.yPosition,
          },
        }));
      },
      onTableLock: (event) => {
        console.log('ğŸ“¥ Received TABLE_LOCK:', event);
        const lockEvent = event.event as {
          tableKey: number;
          userEmail?: string;
          userName?: string;
        };

        // ë½ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ìê¸° ìì‹  í¬í•¨)
        if (lockEvent.userEmail && lockEvent.userName) {
          // ìê¸° ìì‹ ì˜ ë½ì¸ ê²½ìš°
          if (event.userKey === currentUser?.userKey) {
            console.log(`âœ… ë‚´ê°€ ë½ì„ íšë“í–ˆìŠµë‹ˆë‹¤: ${lockEvent.tableKey}`);
            // ìê¸° ìì‹ ì˜ ë½ì€ ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²ŒëŠ” ì ê¹€ í‘œì‹œ ì•ˆ í•¨)
            return;
          }

          // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë½ì„ íšë“í•œ ê²½ìš°
          setTableLockState(`table-${lockEvent.tableKey}`, true, {
            userEmail: lockEvent.userEmail,
            userName: lockEvent.userName,
          });
          console.log(
            `ğŸ”’ í…Œì´ë¸”ì´ ì ê²¼ìŠµë‹ˆë‹¤: ${lockEvent.tableKey} by ${lockEvent.userName}`,
          );
        }
      },
      onTableUnlock: (event) => {
        console.log('ğŸ“¥ Received TABLE_UNLOCK:', event);
        const unlockEvent = event.event as {
          tableKey: number;
          userEmail?: string;
        };

        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë½ì„ í•´ì œí•œ ê²½ìš°
        setTableLockState(`table-${unlockEvent.tableKey}`, false);
        console.log(`ğŸ”“ í…Œì´ë¸” ì ê¸ˆì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤: ${unlockEvent.tableKey}`);
      },
      onColumnCreate: (event) => {
        console.log('ğŸ“¥ Received COLUMN_NEW:', event);

        const columnData = event.event as unknown as {
          columnKey: number;
          tableKey: number;
          logicalName: string;
          physicalName: string;
          dataType: string;
          dataDetail: string[] | null;
          isNullable: boolean;
          isPrimaryKey: boolean;
          isForeignKey: boolean;
          isUnique: boolean;
          isIncremental: boolean;
          defaultValue: string | null;
          comment: string;
          columnOrder: number;
        };

        const newColumn = {
          id: `column-${columnData.columnKey}`,
          key: columnData.columnKey,
          isPK: columnData.isPrimaryKey,
          isFK: columnData.isForeignKey,
          logicalName: columnData.logicalName || 'Logical Name',
          physicalName: columnData.physicalName || 'Physical Name',
          domain: '',
          dataType: columnData.dataType || 'VARCHAR',
          allowNull: columnData.isNullable ? 'Y' : 'N',
          defaultValue: columnData.defaultValue || 'Default Value',
          comment: columnData.comment || 'Comment',
        };

        // ë‚´ê°€ ìƒì„±í•œ ì»¬ëŸ¼ì´ë©´ keyë§Œ ì—…ë°ì´íŠ¸ (updateColumnFromWebSocketì´ ì„ì‹œ ì»¬ëŸ¼ì„ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸)
        if (event.userKey === currentUser?.userKey) {
          updateColumnFromWebSocket(columnData.tableKey, newColumn);
          console.log('ğŸ”„ ë‚´ê°€ ìƒì„±í•œ ì»¬ëŸ¼ì— key ì—…ë°ì´íŠ¸:', newColumn.key);
          return;
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìƒì„±í•œ ì»¬ëŸ¼ì€ ìƒˆë¡œ ì¶”ê°€
        addColumnFromWebSocket(columnData.tableKey, newColumn);
        console.log('ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì»¬ëŸ¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤:', newColumn);
      },
      onColumnUpdate: (event) => {
        console.log('ğŸ“¥ Received COLUMN_UPDATED:', event);
        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        const columnData = event.event as unknown as {
          columnKey: number;
          tableKey?: number;
          logicalName: string;
          physicalName: string;
          dataType: string;
          dataDetail: string[] | null;
          isNullable: boolean;
          isPrimaryKey: boolean;
          isForeignKey: boolean;
          isUnique: boolean;
          isIncremental: boolean;
          defaultValue: string | null;
          comment: string;
          columnOrder: number;
        };

        // tableKeyë¥¼ ì°¾ì•„ì•¼ í•¨ (columnKeyë¡œ í…Œì´ë¸” ì°¾ê¸°)
        // ë°±ì—”ë“œì—ì„œ tableKeyë¥¼ ë³´ë‚´ì£¼ì§€ ì•Šìœ¼ë©´ ëª¨ë“  í…Œì´ë¸”ì—ì„œ ì°¾ì•„ì•¼ í•¨
        const updatedColumn = {
          id: `column-${columnData.columnKey}`,
          key: columnData.columnKey,
          isPK: columnData.isPrimaryKey,
          isFK: columnData.isForeignKey,
          logicalName: columnData.logicalName || '',
          physicalName: columnData.physicalName || '',
          domain: '',
          dataType: columnData.dataType || 'VARCHAR',
          allowNull: columnData.isNullable ? 'Y' : 'N',
          defaultValue: columnData.defaultValue || '',
          comment: columnData.comment || '',
        };
        // columnKeyë¡œ ëª¨ë“  í…Œì´ë¸”ì—ì„œ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
        updateColumnByKeyFromWebSocket(updatedColumn);
        // // tableKeyê°€ ìˆìœ¼ë©´ í•´ë‹¹ í…Œì´ë¸”ì—ì„œ ì—…ë°ì´íŠ¸
        // if (columnData.tableKey) {
        //   updateColumnFromWebSocket(columnData.tableKey, updatedColumn);
        // } else {
        //   // tableKeyê°€ ì—†ìœ¼ë©´ columnKeyë¡œ ëª¨ë“  í…Œì´ë¸”ì—ì„œ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
        //   // ì´ ê²½ìš° ëª¨ë“  í…Œì´ë¸”ì„ ìˆœíšŒí•´ì•¼ í•˜ë¯€ë¡œ ë¹„íš¨ìœ¨ì 
        //   // ì„ì‹œë¡œ ì²« ë²ˆì§¸ í…Œì´ë¸”ì—ì„œ ì‹œë„
        //   console.warn('tableKeyê°€ ì—†ì–´ì„œ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.');
        // }

        console.log('ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì»¬ëŸ¼ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤:', updatedColumn);
      },
      onColumnDelete: (event) => {
        console.log('ğŸ“¥ Received COLUMN_DELETE:', event);
        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        const columnData = event.event as unknown as {
          columnKey: number;
        };

        if (columnData.columnKey) {
          removeColumnFromWebSocket(columnData.columnKey);
          console.log(
            'ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì»¬ëŸ¼ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤:',
            columnData.columnKey,
          );
        }
      },
      onTableCreate: (event) => {
        console.log('ğŸ“¥ Received TABLE_NEW:', event);

        // ë°±ì—”ë“œì—ì„œ ë°›ì€ í…Œì´ë¸” ë°ì´í„°
        const tableData = event.event as unknown as {
          tableKey: number;
          projectKey: number;
          logicalName: string;
          physicalName: string;
          colorHex: string;
          xposition: number;
          yposition: number;
          createdAt: string;
          updatedAt: string;
        };

        // colorHexë¥¼ WorkspaceTableColorë¡œ ë³€í™˜
        const getColorFromHex = (hex: string): WorkspaceTableColor => {
          const normalizedHex = hex.toUpperCase();
          const TABLE_COLOR_HEX_MAP: Record<WorkspaceTableColor, string> = {
            blue: '#1E50AF',
            user2: '#5271C4',
            user3: '#70B2FF',
            user4: '#44C2B3',
            user5: '#A3E0A9',
            user6: '#FFD166',
            user7: '#FF9F5A',
            user8: '#C18AFF',
          };
          const colorEntry = Object.entries(TABLE_COLOR_HEX_MAP).find(
            ([, value]) =>
              value.replace('#', '').toUpperCase() === normalizedHex,
          );
          return (colorEntry?.[0] as WorkspaceTableColor) || 'blue';
        };

        // ìƒˆ í…Œì´ë¸” ìƒì„±
        const newTable: WorkspaceTable = {
          id: `table-${tableData.tableKey}`,
          key: tableData.tableKey,
          name: tableData.logicalName,
          identifier: tableData.physicalName,
          x: tableData.xposition,
          y: tableData.yposition,
          color: getColorFromHex(tableData.colorHex),
          columns: [],
        };

        const isSelfEvent = event.userKey === currentUser?.userKey;

        if (isSelfEvent) {
          // ë‚´ê°€ ìƒì„±í•œ í…Œì´ë¸”: ê¸°ì¡´ ì„ì‹œ í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸
          updateTableFromWebSocket(newTable);
          console.log(
            'âœ… ë‚´ê°€ ìƒì„±í•œ í…Œì´ë¸”ì´ ë°±ì—”ë“œì—ì„œ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤:',
            newTable,
          );
        } else {
          // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìƒì„±í•œ í…Œì´ë¸”: ìƒˆë¡œ ì¶”ê°€
          addTableFromWebSocket(newTable);
          console.log('ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í…Œì´ë¸”ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤:', newTable);
        }
      },
      onTableUpdate: (event) => {
        console.log('ğŸ“¥ Received TABLE_UPDATE:', event);
        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }
        // TODO: í…Œì´ë¸” ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„
        console.log('ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í…Œì´ë¸”ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.');
      },
      onTableDelete: (event) => {
        console.log('ğŸ“¥ Received TABLE_DELETE:', event);
        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        // ì‚­ì œëœ í…Œì´ë¸” í‚¤ ì¶”ì¶œ
        const tableData = event.event as unknown as {
          tableKey: number;
        };

        if (tableData.tableKey) {
          removeTableFromWebSocket(tableData.tableKey);
          console.log(
            'ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í…Œì´ë¸”ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤:',
            tableData.tableKey,
          );
        }
      },
      onRelationCreate: (event) => {
        console.log('ğŸ“¥ Received RELATION_NEW:', event);

        const relationData = event.event as unknown as {
          relationKey: number;
          projectKey: number;
          fromTableKey: number;
          fromColumnKey: number;
          toTableKey: number;
          toColumnKey: number;
          relationType: string;
          constraintName: string;
          onDeleteAction: string;
          onUpdateAction: string;
        };

        // relationTypeì„ cardinalityë¡œ ë³€í™˜
        const cardinalityMap: Record<
          string,
          '1' | '11' | '13' | '01' | '01-1' | '013'
        > = {
          STRICT_ONE_TO_ONE: '11',
          STRICT_ONE_TO_MANY: '13',
          OPTIONAL_ONE_TO_ONE: '01',
          OPTIONAL_ONE_TO_MANY: '013',
        };

        // constraintNameìœ¼ë¡œ type ê²°ì •
        const type: RelationType =
          relationData.constraintName === 'ì‹ë³„'
            ? 'identifying'
            : 'non-identifying';

        const newRelation: WorkspaceRelation = {
          id: `relation-${relationData.relationKey}`,
          sourceTableId: `table-${relationData.fromTableKey}`,
          targetTableId: `table-${relationData.toTableKey}`,
          type,
          cardinality: cardinalityMap[relationData.relationType] || '13',
        };

        // ë‚´ê°€ ìƒì„±í•œ ê´€ê³„ì„ ì´ë©´ ë¬´ì‹œ (ì´ë¯¸ ë¡œì»¬ì—ì„œ ì¶”ê°€ë¨)
        if (event.userKey === currentUser?.userKey) {
          console.log('ğŸ”„ ë‚´ê°€ ìƒì„±í•œ ê´€ê³„ì„ ì…ë‹ˆë‹¤:', newRelation);
          return;
        }

        // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìƒì„±í•œ ê´€ê³„ì„ ì€ ìƒˆë¡œ ì¶”ê°€
        addRelationFromWebSocket(newRelation);
        console.log('ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ê´€ê³„ì„ ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤:', newRelation);
      },
      onRelationDelete: (event) => {
        console.log('ğŸ“¥ Received RELATION_DELETE:', event);
        // ìê¸° ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
        if (event.userKey === currentUser?.userKey) {
          return;
        }

        const relationData = event.event as unknown as {
          relationKey: number;
        };

        if (relationData.relationKey) {
          removeRelationFromWebSocket(relationData.relationKey);
          console.log(
            'ğŸ”„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ê´€ê³„ì„ ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤:',
            relationData.relationKey,
          );
        }
      },
    });

    wsClientRef.current = wsClient;

    // ìë™ìœ¼ë¡œ ì—°ê²° ì‹œì‘
    wsClient.connect();

    return () => {
      console.log('ğŸ”Œ Cleaning up WebSocket...');
      wsClient.disconnect();
    };
  }, [
    isViewMode,
    currentUser,
    updateTablePosition,
    addTableFromWebSocket,
    updateTableFromWebSocket,
    removeTableFromWebSocket,
    addColumnFromWebSocket,
    updateColumnFromWebSocket,
    updateColumnByKeyFromWebSocket,
    removeColumnFromWebSocket,
    addRelationFromWebSocket,
    removeRelationFromWebSocket,
    setTableLockState,
  ]);

  const handleCloseImportModal = useCallback(() => {
    setActiveTool('cursor');
    setIsImportProcessing(false);
  }, [setActiveTool]);

  const handleImportSubmit = useCallback(
    (ddl: string) => {
      setIsImportProcessing(true);
      window.setTimeout(() => {
        const trimmed = ddl.trim();
        const hasCreateTable = /create\s+table/i.test(trimmed);
        const forceError = /force_error/i.test(trimmed);
        const isValid = trimmed.length > 0 && hasCreateTable && !forceError;

        if (isValid) {
          replaceTables(cloneTables(IMPORT_CORRECTED_TABLES));
          setImportResult(null);
          setIsImportResultOpen(false);
        } else {
          setImportResult({
            type: 'error',
            correctedSql: IMPORT_ERROR_SQL,
            changeSummary: IMPORT_ERROR_CHANGE_SUMMARY,
            tables: cloneTables(IMPORT_CORRECTED_TABLES),
          });
          setIsImportResultOpen(true);
        }

        setIsImportProcessing(false);
        handleCloseImportModal();
      }, 600);
    },
    [handleCloseImportModal, replaceTables],
  );

  const handleImportResultConfirm = useCallback(() => {
    if (importResult?.tables) {
      replaceTables(cloneTables(importResult.tables));
    }
    setImportResult(null);
    setIsImportResultOpen(false);
  }, [importResult, replaceTables]);

  const handleImportResultClose = useCallback(() => {
    setImportResult(null);
    setIsImportResultOpen(false);
    setIsImportRetryOpen(true);
  }, []);

  const handleImportRetryConfirm = useCallback(() => {
    setIsImportRetryOpen(false);
    setActiveTool('import');
    setIsImportProcessing(false);
  }, [setActiveTool]);

  const handleCloseExportModal = useCallback(() => {
    setActiveTool('cursor');
    setSqlPreview('');
    setIsPreviewLoading(false);
    setIsCopying(false);
    setShowCopyToast(false);
  }, [setActiveTool]);

  const handlePreviewClick = useCallback(
    async (database: ExportDatabase) => {
      if (!projectKey) {
        console.error('projectKeyê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      setIsPreviewLoading(true);

      // ExportDatabaseë¥¼ SqlDialectë¡œ ë³€í™˜
      const dialectMap: Record<ExportDatabase, SqlDialect> = {
        mysql: 'MYSQL',
        postgresql: 'POSTGRESQL',
      };
      const dialect = dialectMap[database];

      try {
        const sql = await exportErdToSql(projectKey, dialect);
        setSqlPreview(sql);
      } catch (error) {
        console.error('SQL Export ì‹¤íŒ¨:', error);
        // ì—ëŸ¬ ì‹œ ë”ë¯¸ ë°ì´í„° í‘œì‹œ
        setSqlPreview(dummySqlPreview[database]);
      } finally {
        setIsPreviewLoading(false);
      }
    },
    [projectKey],
  );

  const handleCopyClick = useCallback(
    async (database: ExportDatabase) => {
      const textToCopy =
        sqlPreview && sqlPreview.trim().length > 0
          ? sqlPreview
          : dummySqlPreview[database];

      if (!textToCopy) {
        return;
      }

      if (!sqlPreview || sqlPreview.trim().length === 0) {
        setSqlPreview(dummySqlPreview[database]);
      }

      setIsCopying(true);
      try {
        if (
          navigator.clipboard &&
          typeof navigator.clipboard.writeText === 'function'
        ) {
          await navigator.clipboard.writeText(textToCopy);
        } else {
          const textarea = document.createElement('textarea');
          textarea.value = textToCopy;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }
        setShowCopyToast(true);
      } catch (error) {
        console.error('SQL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', error);
      } finally {
        setIsCopying(false);
      }
    },
    [sqlPreview],
  );

  useEffect(() => {
    if (!showCopyToast) {
      return;
    }

    const timer = window.setTimeout(() => {
      setShowCopyToast(false);
    }, 2000);

    return () => window.clearTimeout(timer);
  }, [showCopyToast]);

  const isImportModalOpen = activeTool === 'import';
  const isExportModalOpen = activeTool === 'export';

  return (
    <>
      <div className="flex w-full flex-col">
        <div className="flex h-[calc(100vh-70px)] min-h-[calc(100vh-70px)] overflow-hidden bg-my-white">
          {/* ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì™¼ìª½ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */}
          {!isViewMode && <LeftSideBar />}
          <div className="flex min-h-0 flex-1 overflow-hidden">
            <WorkspaceCanvas
              mode={mode}
              wsClient={wsClientRef.current}
              currentUserKey={currentUser?.userKey}
            />
          </div>
          {/* ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */}
          {!isViewMode && <RightSideBar />}
        </div>
      </div>

      {/* ë·°ì–´ ëª¨ë“œì—ì„œëŠ” Import/Export ëª¨ë‹¬ ìˆ¨ê¹€ */}
      {!isViewMode && (
        <>
          <ImportModal
            isOpen={isImportModalOpen}
            onClose={handleCloseImportModal}
            onSubmit={handleImportSubmit}
            isProcessing={isImportProcessing}
          />
          <ExportModal
            isOpen={isExportModalOpen}
            onClose={handleCloseExportModal}
            sqlPreview={sqlPreview}
            onClickPreview={handlePreviewClick}
            onClickDownload={handleCopyClick}
            isPreviewLoading={isPreviewLoading}
            isDownloadLoading={isCopying}
          />
          {importResult && (
            <ImportResultModal
              isOpen={isImportResultOpen}
              onClose={handleImportResultClose}
              onConfirm={handleImportResultConfirm}
              type={importResult.type}
              correctedSql={importResult.correctedSql}
              changeSummary={importResult.changeSummary}
            />
          )}
          <ImportRetryModal
            isOpen={isImportRetryOpen}
            message="SQLë¬¸ì„ ë‹¤ì‹œ ì…ë ¥í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
            onConfirm={handleImportRetryConfirm}
          />
        </>
      )}
      {showCopyToast && (
        <div className="fixed bottom-6 left-1/2 z-50">
          <div className="-translate-x-1/2 transform">
            <div className="flex items-center gap-2 rounded-[10px] bg-my-black px-6 py-3 text-my-white shadow-lg animate-fadeIn">
              <BuildSuccessIcon className="h-5 w-5" />
              <span className="font-pretendard text-sm font-medium">
                SQLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.
              </span>
            </div>
          </div>
        </div>
      )}


      {/* ì›ê²© ì»¤ì„œë“¤ ë Œë”ë§ */}
      {!isViewMode &&
        Object.values(remoteCursors).map((cursor) => (
          <RemoteCursor
            key={cursor.userEmail}
            userName={cursor.userName}
            userColor={cursor.userColor}
            xPosition={cursor.xPosition}
            yPosition={cursor.yPosition}
          />
        ))}

      {/* AI ì´ˆì•ˆ ì»¨íŒ ë°°ë„ˆ */}
      {!isViewMode && (
        <AiDraftConfirmBanner
          isOpen={isAiDraftConfirmOpen}
          // onConfirm={handleAiDraftConfirm}
          onConfirm={() => console.log("ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŒ.")}
          onCancel={handleAiDraftCancel}
          tableCount={aiPreviewTables.length}
          explanation={aiDraftResult?.explanation}
        />
      )}
    </>
  );
};

interface WorkSpacePageProps {
  mode?: WorkspaceMode;
  projectKeyFromViewCode?: number;
}

const WorkSpacePage: React.FC<WorkSpacePageProps> = ({
  mode = 'edit',
  projectKeyFromViewCode,
}) => {
  const params = useParams<{ projectKey: string; viewId: string }>();

  // [í•µì‹¬ ë¡œì§] projectKey ê²°ì •:
  // 1. /project/:projectKey/workspace ë¼ìš°íŠ¸ì¼ ê²½ìš°: params.projectKey ì‚¬ìš©
  // 2. /viewer/:viewId ë¼ìš°íŠ¸ì¼ ê²½ìš°: undefined
  //    (ì´í›„ WorkspaceProviderê°€ viewIdë¥¼ ì´ìš©í•´ ì„œë²„ì—ì„œ projectKeyë¥¼ ì°¾ì•„ì•¼ í•¨)
  const keyFromUrl = params.projectKey
    ? parseInt(params.projectKey, 10)
    : projectKeyFromViewCode;
  // const viewIdFromUrl = params.viewId;

  // URLì—ì„œ ê°€ì ¸ì˜¨ projectKeyë¥¼ Providerì—ê²Œ propìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
  // ì´ Propì´ WorkspaceProviderì˜ ì´ˆê¸° ë°ì´í„° ë¡œë“œì— ì‚¬ìš©ë©ë‹ˆë‹¤.
  return (
    <WorkspaceProvider
      mode={mode}
      initialProjectKey={keyFromUrl} // [ìˆ˜ì •] Propìœ¼ë¡œ key ì „ë‹¬
      // viewId={viewIdFromUrl}       // [ì¶”ê°€] ë·°ì–´ ëª¨ë“œì¼ ë•Œ viewId ì „ë‹¬
    >
      <WorkspaceLayout mode={mode} />
    </WorkspaceProvider>
  );
};

export default WorkSpacePage;
