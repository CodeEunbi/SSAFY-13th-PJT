# =============================================================================
# Support EC2용 Nginx SSL 리버스 프록시 설정
# =============================================================================

events {
    worker_connections 1024;    # 동시 연결 수 제한 (기본적인 부하 처리)
}

http {
    include       /etc/nginx/mime.types;          # MIME 타입 정의 파일 포함
    default_type  application/octet-stream;       # 기본 MIME 타입 설정
    
    # 로그 포맷 정의 (접근 로그 형식 커스터마이징)
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;    # 접근 로그 파일 경로
    error_log  /var/log/nginx/error.log warn;     # 에러 로그 파일 경로 (warn 레벨)
    
    # 성능 최적화 설정
    sendfile        on;         # 파일 전송 최적화 (커널 레벨 파일 전송)
    tcp_nopush      on;         # TCP 패킷 최적화 (sendfile과 함께 사용)
    tcp_nodelay     on;         # TCP 지연 비활성화 (실시간성 향상)
    keepalive_timeout 65;       # Keep-Alive 연결 유지 시간 (초)
    
    # Gzip 압축 설정 (대역폭 절약)
    gzip on;                    # Gzip 압축 활성화
    gzip_vary on;               # Vary 헤더 추가 (프록시 캐싱 최적화)
    gzip_min_length 1024;       # 압축 최소 파일 크기
    gzip_types text/plain text/css application/json application/javascript;  # 압축할 MIME 타입
    
    # 업스트림 서버 정의 (로드 밸런싱 및 장애 대응)
    upstream spring_backend {
        server spring-app:8080;                   # Spring Boot 컨테이너 (docker-compose 내부망)
        keepalive 32;                             # 업스트림 연결 풀 유지
    }
    
    upstream mlflow_backend {
        server mlflow-server:5000;                # MLflow 컨테이너 (docker-compose 내부망)
        keepalive 16;                             # MLflow용 연결 풀 (상대적으로 적은 요청)
    }
    
    # ==========================================================================
    # HTTP 서버 (포트 80) - ACME Challenge + HTTPS 리다이렉트
    # ==========================================================================
    server {
        listen 80;                                # HTTP 포트 80에서 수신 대기
        server_name ${DOMAIN_NAME};               # 환경변수로 도메인명 설정
        
        # Let's Encrypt ACME Challenge 처리 (SSL 인증서 발급/갱신용)
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;                # certbot 웹루트 디렉토리
            try_files $uri =404;                  # 파일이 없으면 404 에러
        }
        
        # 나머지 모든 HTTP 요청을 HTTPS로 리다이렉트
        location / {
            return 301 https://$server_name$request_uri;  # 301 영구 리다이렉트
        }
    }
    
    # ==========================================================================
    # HTTPS 서버 (포트 443) - 메인 서비스 제공
    # ==========================================================================
    server {
        listen 443 ssl http2;                     # HTTPS + HTTP/2 지원
        server_name ${DOMAIN_NAME};               # 도메인명 (환경변수)
        
        # SSL 인증서 설정 (Let's Encrypt)
        ssl_certificate /etc/letsencrypt/live/${DOMAIN_NAME}/fullchain.pem;      # SSL 인증서 체인
        ssl_certificate_key /etc/letsencrypt/live/${DOMAIN_NAME}/privkey.pem;    # SSL 개인키
        
        # SSL 보안 설정 (Mozilla Modern Configuration 기반)
        ssl_session_timeout 1d;                   # SSL 세션 타임아웃
        ssl_session_cache shared:SSL:50m;         # SSL 세션 캐시 (50MB)
        ssl_session_tickets off;                  # SSL 세션 티켓 비활성화 (보안 강화)
        
        # 최신 TLS 프로토콜만 허용
        ssl_protocols TLSv1.2 TLSv1.3;           # TLS 1.2, 1.3만 허용
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;  # 강력한 암호화 스위트
        ssl_prefer_server_ciphers off;            # 클라이언트 암호화 우선순위 허용
        
        # 보안 헤더 추가
        add_header Strict-Transport-Security "max-age=63072000" always;   # HSTS 헤더 (2년)
        add_header X-Frame-Options DENY always;                          # 클릭재킹 방지
        add_header X-Content-Type-Options nosniff always;                # MIME 스니핑 방지
        
        # =======================================================================
        # MLflow 서비스 (외부 GPU 서버 전용) - 443 포트 제한 조건 충족
        # =======================================================================
        location /mlflow/ {
            # 외부 GPU 서버 IP만 접근 허용 (보안 강화)
            allow ${GPU_SERVER_IP};               # 환경변수로 GPU 서버 IP 설정
            deny all;                             # 나머지 모든 IP 차단
            
            # MLflow 업스트림으로 프록시
            proxy_pass http://mlflow_backend/;    # 뒤의 슬래시 중요 (URL 리라이팅)
            
            # 프록시 헤더 설정
            proxy_set_header Host $host;                          # 원본 호스트 헤더 전달
            proxy_set_header X-Real-IP $remote_addr;              # 실제 클라이언트 IP
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 프록시 체인 IP
            proxy_set_header X-Forwarded-Proto $scheme;           # 프록시 프로토콜 (https)
            
            # MLflow 특화 설정
            proxy_connect_timeout 300s;           # MLflow 서버 연결 타임아웃 (모델 로딩 시간 고려)
            proxy_send_timeout 300s;              # 요청 전송 타임아웃
            proxy_read_timeout 300s;              # 응답 읽기 타임아웃 (큰 모델 업로드 고려)
            
            # 큰 파일 업로드 지원 (AI 모델 업로드용)
            client_max_body_size 10G;             # 최대 10GB 파일 업로드 허용
        }
        
        # =======================================================================
        # Spring Boot 관리 API (내부 관리용)
        # =======================================================================
        location /api/ {
            # Spring Boot 업스트림으로 프록시
            proxy_pass http://spring_backend/;    # Spring Boot 서비스로 전달
            
            # 표준 프록시 헤더 설정
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Spring Boot 타임아웃 설정
            proxy_connect_timeout 60s;            # 연결 타임아웃
            proxy_send_timeout 60s;               # 전송 타임아웃
            proxy_read_timeout 60s;               # 읽기 타임아웃
        }
        
        # =======================================================================
        # Spring Boot Actuator (헬스체크 및 모니터링)
        # =======================================================================
        location /actuator/ {
            proxy_pass http://spring_backend/actuator/;   # Actuator 엔드포인트
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 헬스체크는 빠른 응답 필요
            proxy_connect_timeout 10s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }
        
        # =======================================================================
        # 기본 페이지 (서비스 상태 확인용)
        # =======================================================================
        location / {
            return 200 '{"status":"healthy","services":["spring","mlflow"],"timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;     # JSON 응답 타입
            access_log off;                               # 헬스체크 로그 제외
        }
        
        # =======================================================================
        # 에러 페이지 커스터마이징
        # =======================================================================
        error_page 404 /404.html;                # 404 에러 페이지
        error_page 500 502 503 504 /50x.html;    # 5xx 에러 페이지
        
        location = /404.html {
            return 404 '{"error":"Not Found","code":404}';
            add_header Content-Type application/json;
        }
        
        location = /50x.html {
            return 500 '{"error":"Internal Server Error","code":500}';
            add_header Content-Type application/json;
        }
    }
}
