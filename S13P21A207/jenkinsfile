// jenkinsfile (í”„ë¡œì íŠ¸ ë£¨íŠ¸)
pipeline {
    agent any

    environment {
        GITLAB_REPO = 'https://lab.ssafy.com/s13-bigdata-dist-sub1/S13P21A207.git'
        MAIN_DEPLOY_PATH = '/home/ubuntu/app'
    }

    stages {
        stage('Prepare Environment') {
            steps {
                script {
                    echo "ğŸ”§ í™˜ê²½ ì¤€ë¹„ ì¤‘..."

                    sh '''
                        # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
                        mkdir -p ${MAIN_DEPLOY_PATH}/{models/{text,image},logs/{fastapi,nginx},extension-downloads}
                        chmod -R 755 ${MAIN_DEPLOY_PATH}

                        # Docker ë²„ì „ í™•ì¸
                        docker --version
                        docker-compose --version || echo "Docker Compose ì„¤ì¹˜ í•„ìš”"

                        echo "âœ… í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ"
                    '''
                }
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'develop',
                    credentialsId: 'gitlab-token',
                    url: "${GITLAB_REPO}"
            }
        }

        stage('Detect Changes') {
            steps {
                script {
                    def changes = sh(
                        script: 'git diff --name-only HEAD~1 HEAD || echo "all"',
                        returnStdout: true
                    ).trim().split('\n')

                    // ì‹¤ì œ ì†ŒìŠ¤ì½”ë“œ ê²½ë¡œ ê¸°ë°˜ ë³€ê²½ ê°ì§€
                    env.DEPLOY_MAIN = changes.any {
                        it.startsWith('Service/') ||           // FastAPI ì†ŒìŠ¤ì½”ë“œ ë³€ê²½
                        it.startsWith('Infra/main-ec2/')            // ë©”ì¸ EC2 ì¸í”„ë¼ ë³€ê²½
                    } ? 'true' : 'false'

                    env.DEPLOY_EXTENSION = changes.any {
                        it.startsWith('Front-End/SSAFY_PJT2/') ||    // í¬ë¡¬ ìµìŠ¤í…ì…˜ ì†ŒìŠ¤ì½”ë“œ ë³€ê²½
                        it.startsWith('Infra/main-ec2/')             // ë©”ì¸ EC2 ì¸í”„ë¼ ë³€ê²½ ì‹œì—ë„ ìµìŠ¤í…ì…˜ ì¬ë¹Œë“œ
                    } ? 'true' : 'false'

                    echo "ğŸ” ë³€ê²½ ê°ì§€ ê²°ê³¼:"
                    echo "  â€¢ ë©”ì¸ EC2 ë°°í¬: ${env.DEPLOY_MAIN}"
                    echo "  â€¢ í¬ë¡¬ ìµìŠ¤í…ì…˜ ë°°í¬: ${env.DEPLOY_EXTENSION}"
                }
            }
        }

        stage('Deploy Main EC2 (Local)') {
            when {
                anyOf {
                    allOf {
                        branch 'develop'  // develop ë¸Œëœì¹˜ì—ì„œ
                        anyOf {
                            environment name: 'DEPLOY_MAIN', value: 'true'  // ë³€ê²½ì‚¬í•­ì´ ìˆê±°ë‚˜
                            expression { currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause').size() > 0 }  // ìˆ˜ë™ ë¹Œë“œ
                        }
                    }
                    expression { currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause').size() > 0 }  // Jenkinsì—ì„œ ìˆ˜ë™ ë¹Œë“œ ì‹œ í•­ìƒ ì‹¤í–‰
                }
            }
            steps {
                script {
                    echo "ğŸš€ ë©”ì¸ EC2 ë¡œì»¬ ë°°í¬ ì‹œì‘..."

                    withCredentials([
                        file(credentialsId: 'main-env-file', variable: 'MAIN_ENV')
                    ]) {
                        sh '''
                            # === ê°•í™”ëœ ë””ë ‰í† ë¦¬ ìƒì„± ===
                            echo "ğŸ“ í•„ìˆ˜ ë””ë ‰í† ë¦¬ ê°•ì œ ìƒì„± ì¤‘..."
                            mkdir -p ${MAIN_DEPLOY_PATH}/{models/{text,image},logs/{fastapi,nginx},extension-downloads,data}
                            chmod -R 755 ${MAIN_DEPLOY_PATH}

                            # ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
                            echo "ğŸ“‹ ë””ë ‰í† ë¦¬ í™•ì¸:"
                            ls -la ${MAIN_DEPLOY_PATH}/

                            # models ë””ë ‰í† ë¦¬ ê°•ì œ ìƒì„±
                            if [ ! -d "${MAIN_DEPLOY_PATH}/models" ]; then
                                echo "âš ï¸ models ë””ë ‰í† ë¦¬ ì—†ìŒ - ê°•ì œ ìƒì„±"
                                mkdir -p ${MAIN_DEPLOY_PATH}/models/{text,image}
                                chmod -R 755 ${MAIN_DEPLOY_PATH}/models
                            fi

                            # === íŒŒì¼ ë³µì‚¬ (git êµ¬ì¡°ì™€ ë™ì¼í•˜ê²Œ) ===
                            # ë³µì‚¬ ì „ ê¸°ì¡´ íŒŒì¼ë“¤ì„ ì •ë¦¬
                            rm -rf ${MAIN_DEPLOY_PATH}/{Service,Front-End,Infra}

                            # ë©”ì¸ EC2ì— í•„ìš”í•œ í´ë”ë“¤ì„ ë‚´ë¶€ íŒŒì¼ê¹Œì§€ ì™„ì „íˆ ë³µì‚¬
                            cp -r Service ${MAIN_DEPLOY_PATH}/
                            cp -r Front-End ${MAIN_DEPLOY_PATH}/
                            cp -r Infra ${MAIN_DEPLOY_PATH}/
                            cp $MAIN_ENV ${MAIN_DEPLOY_PATH}/.env

                            cd ${MAIN_DEPLOY_PATH}
                            export $(cat .env | xargs)

                            # === AI ëª¨ë¸ íŒŒì¼ ë³µì‚¬ ===
                            echo "ğŸ“¥ AI ëª¨ë¸ íŒŒì¼ ë³µì‚¬ ì¤‘..."

                            # ëª¨ë¸ ì„œë¸Œë””ë ‰í† ë¦¬ ìƒì„±
                            mkdir -p models/text models/image
                            chmod -R 755 models/

                            if [ -d "Service/ai-text-service/models" ]; then
                                cp -r Service/ai-text-service/models/* models/text/ || true
                                echo "âœ… Text ëª¨ë¸ ë³µì‚¬ ì™„ë£Œ"
                                ls -la models/text/
                            else
                                echo "âš ï¸ Text ëª¨ë¸ ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ"
                            fi

                            if [ -d "Service/ai-image-service/models" ]; then
                                cp -r Service/ai-image-service/models/* models/image/ || true
                                echo "âœ… Image ëª¨ë¸ ë³µì‚¬ ì™„ë£Œ"
                                ls -la models/image/
                            else
                                echo "âš ï¸ Image ëª¨ë¸ ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ"
                            fi

                            # === ì•ˆì „í•œ ëª¨ë¸ íŒŒì¼ ìƒì„± ===
                            echo "ğŸ“¥ ê¸°ë³¸ ëª¨ë¸ ì„¤ì • ì¤‘..."
                            if [ -d "models" ]; then
                                echo "ê¸°ë³¸ ëª¨ë¸ íŒŒì¼" > models/latest
                                echo "âœ… models/latest íŒŒì¼ ìƒì„± ì™„ë£Œ"
                            else
                                echo "âŒ models ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨!"
                                exit 1
                            fi

                            # === Docker ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ===
                            echo "ğŸ”„ ë©”ì¸ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
                            docker-compose -f Infra/main-ec2/docker-compose.main.yml down || true
                            docker-compose -f Infra/main-ec2/docker-compose.main.yml up -d --build

                            echo "âœ… ë©”ì¸ EC2 ë°°í¬ ì™„ë£Œ"
                        '''
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."

                    // ë©”ì¸ EC2 í—¬ìŠ¤ì²´í¬
                    sh '''
                        if [ "${DEPLOY_MAIN}" = "true" ]; then
                            echo "ğŸ” ë©”ì¸ EC2 FastAPI ìƒíƒœ í™•ì¸..."
                            sleep 45

                            # FastAPI í—¬ìŠ¤ì²´í¬
                            for i in {1..10}; do
                                if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                                    echo "âœ… ë©”ì¸ EC2 FastAPI ì •ìƒ ë™ì‘"
                                    break
                                fi
                                echo "â³ FastAPI ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/10)"
                                sleep 10
                            done
                        fi
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ ëª¨ë“  ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'
            script {
                // ì„±ê³µ ì‹œ ìƒíƒœ í™•ì¸
                sh '''
                    echo "ğŸ“Š ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ:"
                    docker ps --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
                '''
            }
        }

        failure {
            echo 'âŒ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
            script {
                // ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ìˆ˜ì§‘
                sh '''
                    echo "ğŸ’¥ ë©”ì¸ EC2 ë¡œê·¸:"
                    docker-compose -f ${MAIN_DEPLOY_PATH}/Infra/main-ec2/docker-compose.main.yml logs --tail=50 || true
                '''

            }
        }

        always {
            // ì •ë¦¬ ì‘ì—…
            sh '''
                # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë³´ì•ˆ ì‚­ì œ
                rm -f ${MAIN_DEPLOY_PATH}/.env || true

                # ë¯¸ì‚¬ìš© Docker ì´ë¯¸ì§€ ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
                docker image prune -f || true
            '''
        }
    }
}