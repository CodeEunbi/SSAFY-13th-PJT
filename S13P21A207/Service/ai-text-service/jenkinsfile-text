pipeline {
    agent any
    
    environment {
        GITLAB_REPO = 'https://lab.ssafy.com/s13-bigdata-dist-sub1/S13P21A207.git'
        BRANCH_NAME = 'deploy-text'
        SERVICE_NAME = 'ai-text-service'
        SERVICE_PATH = 'Service/ai-text-service'
        DEPLOY_PATH = '/home/ubuntu/services/text'
        SERVICE_PORT = '8002'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ”„ ${SERVICE_NAME} ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ ì¤‘..."
                git branch: "${BRANCH_NAME}", 
                    credentialsId: 'gitlab-token',
                    url: "${GITLAB_REPO}"
            }
        }
        
        stage('Prepare Deploy Directory') {
            steps {
                echo "ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì¤‘..."
                sh '''
                    # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
                    mkdir -p ${DEPLOY_PATH}
                    chmod -R 755 ${DEPLOY_PATH}
                    
                    # ê¸°ì¡´ íŒŒì¼ ë°±ì—… ë° ì •ë¦¬
                    if [ -d "${DEPLOY_PATH}/backup" ]; then
                        rm -rf ${DEPLOY_PATH}/backup
                    fi
                    
                    if [ -d "${DEPLOY_PATH}/app" ]; then
                        mv ${DEPLOY_PATH}/app ${DEPLOY_PATH}/backup
                    fi
                    
                    echo "âœ… ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"
                '''
            }
        }
        
        stage('Copy Service Files') {
            steps {
                echo "ğŸ“¦ ${SERVICE_NAME} íŒŒì¼ ë³µì‚¬ ì¤‘..."
                sh '''
                    # ì„œë¹„ìŠ¤ íŒŒì¼ ë³µì‚¬
                    cp -r ${SERVICE_PATH} ${DEPLOY_PATH}/app
                    
                    # ê¶Œí•œ ì„¤ì •
                    chmod -R 755 ${DEPLOY_PATH}/app
                    
                    # ë³µì‚¬ëœ íŒŒì¼ í™•ì¸
                    echo "ğŸ“‹ ë³µì‚¬ëœ íŒŒì¼ ëª©ë¡:"
                    ls -la ${DEPLOY_PATH}/app/
                    
                    echo "âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
                '''
            }
        }
        
        stage('Build Docker text') {
            steps {
                echo "ğŸ”¨ ${SERVICE_NAME} Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                sh '''
                    cd ${DEPLOY_PATH}/app
                    
                    # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
                    docker stop ${SERVICE_NAME} || true
                    docker rm ${SERVICE_NAME} || true
                    
                    # ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±°
                    docker rmi ${SERVICE_NAME}:latest || true
                    
                    # Docker ì´ë¯¸ì§€ ë¹Œë“œ
                    docker build -t ${SERVICE_NAME}:latest .
                    
                    echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
                '''
            }
        }
        
        stage('Deploy Container') {
            when {
                anyOf {
                    branch ${BRANCH_NAME}  // deploy-text ë¸Œëœì¹˜ì— merge ì‹œ ìë™ ë°°í¬
                    expression { currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause').size() > 0 }  // Jenkinsì—ì„œ ìˆ˜ë™ ë¹Œë“œ ì‹œ
                }
            }
            steps {
                echo "ğŸš€ ${SERVICE_NAME} ì»¨í…Œì´ë„ˆ ë°°í¬ ì¤‘..."
                sh '''
                    cd ${DEPLOY_PATH}/app
                    
                    # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (í•„ìš”ì‹œ)
                    if [ ! -f .env ]; then
                        cp .env.example .env || echo "SERVICE_NAME=${SERVICE_NAME}" > .env
                    fi
                    
                    # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                    docker run -d \
                        --name ${SERVICE_NAME} \
                        --restart unless-stopped \
                        -p ${SERVICE_PORT}:8000 \
                        --env-file .env \
                        ${SERVICE_NAME}:latest
                    
                    echo "âœ… ì»¨í…Œì´ë„ˆ ë°°í¬ ì™„ë£Œ"
                '''
            }
        }
        
        stage('Health Check') {
            steps {
                echo "ğŸ¥ ${SERVICE_NAME} í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
                sh '''
                    echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
                    sleep 30
                    
                    # Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ìœ¼ë¡œ í—¬ìŠ¤ì²´í¬ ëŒ€ì²´
                    if docker ps --filter name=${SERVICE_NAME} --filter status=running | grep -q ${SERVICE_NAME}; then
                        echo "âœ… ${SERVICE_NAME} ì»¨í…Œì´ë„ˆ ì •ìƒ ì‹¤í–‰ ì¤‘!"
                        
                        # Docker í—¬ìŠ¤ì²´í¬ ìƒíƒœ í™•ì¸ (ìˆëŠ” ê²½ìš°)
                        health_status=$(docker inspect --format='{{.State.Health.Status}}' ${SERVICE_NAME} 2>/dev/null || echo "none")
                        echo "Docker í—¬ìŠ¤ì²´í¬ ìƒíƒœ: $health_status"
                        
                        echo "ğŸŒ ì„œë¹„ìŠ¤ URL: http://$(curl -s ifconfig.me):${SERVICE_PORT}"
                        echo "âœ… ë°°í¬ ì™„ë£Œ - ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
                        exit 0
                    else
                        echo "âŒ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"
                        docker logs ${SERVICE_NAME} --tail=50
                        exit 1
                    fi
                '''
            }
        }
    }
    
    post {
        success {
            echo "ğŸ‰ ${SERVICE_NAME} ë°°í¬ ì„±ê³µ!"
            sh '''
                echo "ğŸ“Š ë°°í¬ ì™„ë£Œ ìƒíƒœ:"
                docker ps --filter name=${SERVICE_NAME} --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
                echo "ğŸŒ ì„œë¹„ìŠ¤ ì ‘ê·¼: http://$(curl -s ifconfig.me):${SERVICE_PORT}"
            '''
        }
        
        failure {
            echo "âŒ ${SERVICE_NAME} ë°°í¬ ì‹¤íŒ¨!"
            sh '''
                echo "ğŸ’¥ ì‹¤íŒ¨ ë¡œê·¸ ìˆ˜ì§‘ ì¤‘..."
                
                # Docker ë¡œê·¸ ì¶œë ¥
                if docker ps -a --filter name=${SERVICE_NAME} --format {{.Names}} | grep -q ${SERVICE_NAME}; then
                    echo "ğŸ” ${SERVICE_NAME} ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
                    docker logs ${SERVICE_NAME} --tail=100
                fi
                
                # ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
                echo "ğŸ” ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
                df -h
                free -h
                
                echo "ğŸ” Docker ìƒíƒœ:"
                docker ps -a
            '''
        }
        
        always {
            sh '''
                # ì •ë¦¬ ì‘ì—…
                echo "ğŸ§¹ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰ ì¤‘..."
                
                # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë³´ì•ˆ ì‚­ì œ
                if [ -f "${DEPLOY_PATH}/app/.env" ]; then
                    rm -f ${DEPLOY_PATH}/app/.env
                fi
                
                # ë¯¸ì‚¬ìš© Docker ì´ë¯¸ì§€ ì •ë¦¬
                docker image prune -f || true
                
                echo "âœ… ì •ë¦¬ ì™„ë£Œ"
            '''
        }
    }
}