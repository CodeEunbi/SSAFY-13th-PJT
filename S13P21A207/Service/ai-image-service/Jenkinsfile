pipeline {
  agent any
  environment {
    GITLAB_REPO  = 'https://lab.ssafy.com/s13-bigdata-dist-sub1/S13P21A207.git'
    BRANCH_NAME  = 'deploy-image'
    SERVICE_NAME = 'ai-image-service'
    SERVICE_PORT = '8001'
    CONTAINER_PORT = '8000'
    CREDENTIALS_ID = 'gitlab-token'
    DEPLOY_PATH  = '/home/ubuntu/services/image'
  }

  stages {
    stage('Checkout') {
      steps {
        echo "ğŸ”„ ${SERVICE_NAME} ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ ì¤‘..."
        git branch: "${BRANCH_NAME}", credentialsId: "${CREDENTIALS_ID}", url: "${GITLAB_REPO}"
      }
    }

    stage('Prepare deploy dir') {
      steps {
        echo "ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì¤‘..."
        sh '''
          set -e
          mkdir -p ${DEPLOY_PATH}
          chmod -R 755 ${DEPLOY_PATH}

          # ê¸°ì¡´ íŒŒì¼ ë°±ì—… ë° ì •ë¦¬
          rm -rf ${DEPLOY_PATH}/backup || true
          if [ -d "${DEPLOY_PATH}/app" ]; then
            mv ${DEPLOY_PATH}/app ${DEPLOY_PATH}/backup
          fi

          # ìƒˆ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ${DEPLOY_PATH}/app

          # ë‚´ìš©ë§Œ ë³µì‚¬ (ì¤‘ìš”)
          cp -r Service/ai-image-service/. ${DEPLOY_PATH}/app/
          chmod -R 755 ${DEPLOY_PATH}/app

          # ë¹ ë¥¸ ê²½ë¡œ í™•ì¸
          test -f ${DEPLOY_PATH}/app/Dockerfile
          test -f ${DEPLOY_PATH}/app/requirements.txt

          echo "âœ… ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"
        '''
      }
    }

    stage('Build image') {
      steps {
        echo "ğŸ”¨ ${SERVICE_NAME} Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        script { env.SHA = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim() }
        dir("${DEPLOY_PATH}/app") {
          sh '''
            set -e
            docker stop ${SERVICE_NAME} || true
            docker rm ${SERVICE_NAME} || true
            docker rmi ${SERVICE_NAME}:latest || true
            docker build -t ${SERVICE_NAME}:latest -t ${SERVICE_NAME}:${SHA} .
            echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
          '''
        }
      }
    }

    stage('Run container') {
      when {
        anyOf {
          branch ${BRANCH_NAME}  // deploy-image ë¸Œëœì¹˜ì— merge ì‹œ ìë™ ë°°í¬
          expression { currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause').size() > 0 }  // Jenkinsì—ì„œ ìˆ˜ë™ ë¹Œë“œ ì‹œ
        }
      }
      steps {
        echo "ğŸš€ ${SERVICE_NAME} ì»¨í…Œì´ë„ˆ ë°°í¬ ì¤‘..."
        dir("${DEPLOY_PATH}/app") {
          sh '''
            set -e
            # .env ì—†ìœ¼ë©´ ìƒì„±
            [ -f .env ] || cat > .env <<EOF
MODEL_PATH=./models/student_ft_best.keras
CLASSMAP_PATH=./models/class_mapping.json
THRESH_PATH=./models/thresholds.json
IMG_SIZE=192
TOPK=3
ALLOWED_MIME=image/jpeg,image/png,image/webp,image/avif
EOF
            docker run -d \
              --name ${SERVICE_NAME} \
              --restart unless-stopped \
              -p ${SERVICE_PORT}:${CONTAINER_PORT} \
              --env-file .env \
              ${SERVICE_NAME}:latest

            echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ íŠ¸ë¦¬ê±° ì™„ë£Œ"
          '''
        }
      }
    }

    // âœ… í…ìŠ¤íŠ¸ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•œ Health Check ë°©ì‹ìœ¼ë¡œ ë³€ê²½
    stage('Health Check') {
      steps {
        echo "ğŸ¥ ${SERVICE_NAME} í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
        sh '''
          set -eu
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          # ì§§ì€ ì›Œë°ì—…(í•„ìš” ì‹œ ì¡°ì •)
          sleep 10

          # ì»¨í…Œì´ë„ˆê°€ running ìƒíƒœì¸ì§€ í™•ì¸ (curl ëŒ€ì‹  docker ìƒíƒœë¡œ ì²´í¬)
          if docker ps --filter "name=${SERVICE_NAME}" --filter "status=running" --format "{{.Names}}" | grep -q "^${SERVICE_NAME}$"; then
            echo "âœ… ${SERVICE_NAME} ì»¨í…Œì´ë„ˆ ì •ìƒ ì‹¤í–‰ ì¤‘!"

            # Docker HEALTHCHECKë¥¼ ì •ì˜í•´ë‘ì—ˆë‹¤ë©´ ìƒíƒœë„ í•¨ê»˜ ì¶œë ¥(ì—†ìœ¼ë©´ none)
            health_status=$(docker inspect --format='{{.State.Health.Status}}' ${SERVICE_NAME} 2>/dev/null || echo "none")
            echo "Docker í—¬ìŠ¤ì²´í¬ ìƒíƒœ: $health_status"

            echo "ğŸŒ ì„œë¹„ìŠ¤ URL: http://$(curl -s ifconfig.me):${SERVICE_PORT}"
            echo "âœ… ë°°í¬ ì™„ë£Œ - ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
            exit 0
          else
            echo "âŒ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"
            echo "---- ${SERVICE_NAME} ìµœê·¼ ë¡œê·¸ ----"
            docker logs ${SERVICE_NAME} --tail=100 || true
            exit 1
          fi
        '''
      }
    }
  }

  post {
    success {
      echo "ğŸ‰ ${SERVICE_NAME} ë°°í¬ ì„±ê³µ!"
      sh '''
        echo "ğŸ“Š ë°°í¬ ì™„ë£Œ ìƒíƒœ:"
        docker ps --filter name=${SERVICE_NAME} --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
        echo "ğŸŒ ì„œë¹„ìŠ¤ ì ‘ê·¼: http://$(curl -s ifconfig.me):${SERVICE_PORT}"
      '''
    }
    failure {
      echo "âŒ ${SERVICE_NAME} ë°°í¬ ì‹¤íŒ¨!"
      sh '''
        echo "ğŸ’¥ ì‹¤íŒ¨ ë¡œê·¸ ìˆ˜ì§‘ ì¤‘..."
        if docker ps -a --filter name=${SERVICE_NAME} --format "{{.Names}}" | grep -q "^${SERVICE_NAME}$"; then
          echo "ğŸ” ${SERVICE_NAME} ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
          docker logs ${SERVICE_NAME} --tail=200 || true
        fi
        echo "ğŸ” ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
        df -h
        free -h
        echo "ğŸ” Docker ìƒíƒœ:"
        docker ps -a
      '''
    }
    always {
      sh '''
        echo "ğŸ§¹ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰ ì¤‘..."
        # (ì„ íƒ) .env ì •ë¦¬ â€” ì´ë¯¸ì§€ ì„œë¹„ìŠ¤ëŠ” ìœ ì§€ê°€ í•„ìš”í•˜ë©´ ì£¼ì„ ì²˜ë¦¬
        # rm -f ${DEPLOY_PATH}/app/.env || true

        docker image prune -f || true
        echo "âœ… ì •ë¦¬ ì™„ë£Œ"
      '''
    }
  }
}
